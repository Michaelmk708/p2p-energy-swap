#!/usr/bin/env bash
# Simple launcher for the P2P Energy demo stack.
# Usage:
#   p2p run        # start all services (blockchain, AI, Django, frontend)
#   p2p stop       # stop all services
#   p2p status     # show brief status
#   p2p logs [svc] # tail logs (svc: ai|django|frontend|blockchain|ngrok)

set -euo pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cmd="${1:-help}"
case "$cmd" in
  run)
    exec "$ROOT_DIR/run_all.sh"
    ;;
  install)
    TARGET="$HOME/.local/bin/p2p"
    mkdir -p "$(dirname "$TARGET")"
    ln -sf "$ROOT_DIR/p2p" "$TARGET"
    echo "Linked $TARGET -> $ROOT_DIR/p2p"
    # Try to detect PATH
    case ":$PATH:" in
      *":$HOME/.local/bin:"*) echo "~/.local/bin is already on your PATH." ;;
      *) echo "Note: ~/.local/bin not on PATH. Add this to your shell rc: export PATH=\"\$HOME/.local/bin:\$PATH\"" ;;
    esac
    ;;
  uninstall)
    TARGET="$HOME/.local/bin/p2p"
    if [ -L "$TARGET" ] || [ -f "$TARGET" ]; then
      rm -f "$TARGET"
      echo "Removed $TARGET"
    else
      echo "Nothing to remove at $TARGET"
    fi
    ;;
  stop)
    echo "Stopping servicesâ€¦"
    pkill -f 'manage.py runserver' || true
    pkill -f main_app.py || true
    pkill -f flask_app.py || true
    pkill -f ngrok || true
    pkill -f vite || true
    pkill -f npm || true
    echo "Stopped."
    ;;
  status)
    echo "Processes:"
    ps -eo pid,ppid,etime,cmd | grep -E 'manage.py runserver|main_app.py|flask_app.py|ngrok http|vite|node .*vite|npm run dev' | grep -v grep || true
    echo "\nLogs present:"
    ls -la /tmp/*.{log} 2>/dev/null | grep -E 'ai.log|django.log|frontend.log|blockchain.log|ngrok.log' || true
    ;;
  logs)
    svc="${2:-all}"
    case "$svc" in
      ai) tail -f /tmp/ai.log ;;
      django) tail -f /tmp/django.log ;;
      frontend) tail -f /tmp/frontend.log ;;
      blockchain) tail -f /tmp/blockchain.log ;;
      ngrok) tail -f /tmp/ngrok.log ;;
      all) tail -f /tmp/ai.log /tmp/django.log /tmp/frontend.log /tmp/blockchain.log 2>/dev/null || true ;;
      *) echo "Unknown service: $svc"; exit 1;;
    esac
    ;;
  *)
    cat <<USAGE
p2p - P2P Energy demo launcher

Commands:
  run           start all services (same as ./run_all.sh)
  install       symlink to ~/.local/bin for global usage
  uninstall     remove the symlink from ~/.local/bin
  stop          stop dev services
  status        show processes and log files
  logs [svc]    tail logs: ai|django|frontend|blockchain|ngrok|all
USAGE
    ;;
esac
